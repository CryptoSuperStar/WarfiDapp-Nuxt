# Spring Game contracts

## :warning: Known issues

**Node Rewards test suite**: passing of time is not quite deterministic, and from
time to time the test skips a second and therefore messes up with time-based
calculations. Soltuions exists but are not yet implemented.

# Contracts overview

> Newly (re)written contracts are self-documented, you are invited to read
  through the code to deepen your understanding of the logic.

## `PreSale`

Allow users to pre-order `Item`s in exchange of tokens locked in the contract
until a `Burner` consumes the pre-ordered items by its own business logic. At
creation time, we set an address that will be allowed to manage the funds
locked in the contract. It's meant to be a multi-sig wallet, hence the 
name `multisig`.

An `Item` is defined by its `name`, a `priceRegular` and a `priceWhitelisted`.
The `name` is an arbitrary string and it's the `burner` responsibility to
determine what asset can beissued in exchange of a given `name`.

Users can be whitelisted and by so benefits a special discount rate for every
pre-order placed. Non-whitelisted users will benefit the `priceRegular` price
for a given item, and whitelisted users will benefit the `priceWhitelisted`
price.

Users can pre-order items within a maximum total locked value limit. The
limit is not the same for regular and for whitelisted users and can be
accessed through the `maxTVLPerRegularUser` and `maxTVLPerWhitelistedUser`
getters.

The `burner` is an address that is set by the owner of the contract. It will be
the only one allowed to burn pre-order and will be responsible to instanciate
the corresponding asset.

> :point_up: *This version of the pre-sale contract doesn't guarantee
  the finality of the corresponding asset creation*.

The `multisig` wallet is granted `MaxUint256` allowance to the token holdings
of the contract at creation time. This allowance can be reset back to max
value via the `resetAllowance` method. Funds can be accessed by the 
`multisig` through the `transferFrom` method of the held token's contract.

An emergency mode is available and can by activated by the owners of the
contract. When activated, the only methods callable will be `emergencyRedeem`
and `emergencyRedeemByItem`. When called by an user who locked tokens in the 
contracts, it will cancel their pre-order and send back their tokens. The 
`multisig` wallet is responsible of keeping the balance of token at least equal 
to `getTotalLockedValue`.

### Deployment

```bash
$ npm install # Or alternatively, `yarn`
$ npx hardhat run scripts/presale-deploy.ts`
```

You will be prompted the arguments to provide to the contract.

> :warning: Make sure to configure properly your Hardhat network in the
  `hardhat.config.ts` file, and use the `--network <name>` CLI flag if needed.

### Smart contract interface

> :point_up: This Hardhat project uses Typechain to generate Ethers.js types. Feel
> free to use them by running `npx hardhat compile` and fetching the type
> definitions from the generated `typechain` folder.

> :information_source: This list is not exhaustive, but it should be enough to get you started.
> Explore the rest of the getters through the types generated by Typechain
> or by browsing the `PreSale.sol` source file.

* <code>preSale.**paymentToken**(): *IERC20*</code>:

  The contract accepts payment through an ERC20 token whose address is returned
  by this method. You will need to increase the allowance of the contract before
  placing any pre-order. Using the generated type definitions, you can easily
  do so as follows:

  ```javascript
  const paymentToken = await ethers.getContractAt(
    "IERC20",
    await preSale.paymentToken()
  );

  await paymentToken
    .connect(user)
    .approve(preSale.address, ethers.constants.MaxUint256);
  ```

* <code>preSale.**getItems**(): *ItemView[]*</code>:

  Returns the list of items that can be pre-ordered. *Keep track of the
  indices of the items* in order to refer to them later on.

  ```typescript
  // Typechain will create the type of ItemView for you, otherwise, use this:
  interface ItemView {
    name: string;
    priceRegular: BigNumber;
    priceWhitelisted: BigNumber;
    amountCreated: BigNumber;
    tvl: BigNumber;
  }
  ```

* <code>preSale.**preOrder**(*uint256* **itemIndex**, *uint256* **amount**)</code>:

  Pre-orders an item. The `itemIndex` is the index of the item in the list
  returned by `getItems`. The `amount` is the amount of items to pre-order.

  ```typescript
  // Pre-order two bonzai trees
  const items = await preSale.getItems();
  
  await preSale
    .connect(user)
    .preOrder(items.findIndex(item => item.name === "Bonzai"), 2);
  ```

## `NodeRewards`

*tbd*

## Run tests

Run `npx hardhat test`, or `REPORT_GAS=true npx hardhat test` to have advanced 
gas reporting.